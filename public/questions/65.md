# Q65：Content Moderation（内容审核，面试复述版）

## 1. 三句话题目本质
1. 内容审核系统核心是“低时延决策 + 可追溯复核”。  
2. 难点在误杀与漏审平衡，且要支持文本/图片/视频多模态。  
3. 面试要讲清策略引擎、模型服务、人审闭环和申诉回放。  

## 2. 真实场景故事
短视频平台每分钟新增 30 万条内容，活动期间翻倍。只靠模型会误杀，人工全审又顶不住。  
最终采用“规则先筛 + 模型打分 + 分级队列 + 人审兜底”，并把申诉结果回流策略中心，持续降误杀。  

## 3. 术语白话表（>=10）
|术语|白话解释|面试可复述|
|---|---|---|
|Policy Engine|策略引擎|可配置规则决策|
|Model Score|模型分|表示违规风险|
|Triage Queue|分级队列|高风险先审|
|False Positive|误杀|正常内容被拦截|
|False Negative|漏审|违规内容漏过|
|Appeal|申诉|用户请求复核|
|Shadow Mode|影子模式|新策略先观察不生效|
|Outbox|事务消息表|审核事件可靠投递|
|DLQ|死信队列|失败任务隔离|
|Hot Case|热案例|近期高频规则样本|
|Cold Archive|冷归档|长期审计保存|
|PII Masking|隐私脱敏|保护用户信息|

## 4. 需求澄清（功能/非功能/不做范围/SLO）
### 4.1 功能
- 提交内容审核（文本/图像/视频元数据）。  
- 输出决策：通过、拦截、待人工复审。  
- 审核员工作台、申诉回查、策略发布灰度。  
### 4.2 非功能
- 决策 API P95 < 150ms（文本），图片 < 400ms。  
- 误杀率 < 0.5%，漏审率可控。  
- 可用性 >= 99.95%。  
### 4.3 不做
- 不做法务最终裁定流程。  
- 不做离线批量内容修复工具细节。  
### 4.4 SLO
- `review_latency_p95_text < 150ms`
- `appeal_resolution_p95 < 24h`
- `false_positive_rate < 0.5%`

## 5. 容量估算（数字推导）
- 30 万条/分钟，峰值 60 万条/分钟 = 10k/s。  
- 文本 70%，图片 25%，视频 5%。  
- 模型推理预算：文本 3k/s，图片 2k/s，视频 400/s（其余进入异步审）。  
- 申诉率 0.2%，日申诉约 17.2 万单。  

## 6. 架构（简版+完整版）
### 6.1 简版
```text
Content API -> Rule Engine -> Model Service -> Decision Store
                                  -> Human Review Queue
```
### 6.2 完整版
```text
Client -> Gateway -> Moderation API
      -> Policy Engine (rules/blacklist/regex)
      -> Model Orchestrator (text/image/video)
      -> Tx + Outbox -> MQ(review.event)
      -> Decision Writer
      -> Triage Queue (HIGH/MID/LOW)
      -> Reviewer Console + Appeal Service
      -> Feature Feedback -> Policy Center
```

## 7. API设计（请求/响应/错误码/幂等）
`POST /api/v1/moderation/review`
```json
{
  "contentId":"c_1001",
  "contentType":"image",
  "tenantId":"t1",
  "payload":{"url":"https://.../a.jpg"}
}
```
Headers: `Idempotency-Key: rev-c_1001-1`
Response:
```json
{"decision":"REVIEW","riskScore":0.91,"caseId":"case_11"}
```

`POST /api/v1/moderation/appeals`
```json
{"contentId":"c_1001","reason":"误判"}
```
Response:
```json
{"appealId":"ap_912","status":"QUEUED"}
```

错误码：`MOD_429_RATE_LIMIT`、`MOD_503_MODEL_TIMEOUT`、`MOD_409_DUP_REVIEW`。  

## 8. 数据模型（实体/索引/分片）
- `review_event(event_id, content_id, type, idem_key, state, ts)`  
- `decision(content_id, version, decision, risk_score, reason)`  
- `review_case(case_id, priority, assignee, status, sla_deadline)`  
- `appeal(appeal_id, content_id, status, result, updated_at)`  
- 索引：`review_case(priority, status)`、`decision(content_id, version)`。  
- 分片：按 `tenant_id + day`。  

## 9. 核心流程（正常/高峰/故障恢复）
1. 正常：规则先判 -> 模型补判 -> 决策落库 -> 必要时入人工队列。  
2. 高峰：低风险走快速路径，高风险进入异步队列；模型超时降级为规则+人审。  
3. 故障恢复：队列积压时优先处理高风险；DLQ 任务按 caseId 回放。  

## 10. 一致性与事务边界
- `decision + outbox` 同事务。  
- 人审结果异步更新最终决策版本。  
- 申诉以最新版本决策为准并保留历史版本。  

## 11. 可用性与容错（含RTO/RPO）
- API/规则引擎多副本跨 AZ。  
- 模型服务超时熔断与降级。  
- RTO 20 分钟，RPO 0（决策事件不丢）。  

## 12. 可观测性（指标+阈值+处置动作）
- `model_timeout_rate > 3%`：切到轻模型并降采样视频。  
- `review_queue_lag > 15min`：加开人工班次+扩审核 worker。  
- `false_positive_rate > 0.5%`：回滚新策略版本。  
- `appeal_overdue > 5%`：触发运营升级。  

## 13. 安全与合规
- 审核内容最小可见原则。  
- PII 脱敏存储，审计日志不可篡改。  
- 合规策略按地区版本化发布。  

## 14. 成本与取舍
- 视频审核最贵，先抽帧再精审。  
- 高精度模型贵且慢，分层调用降低成本。  
- CDN 仅用于静态策略文档与控制台资源，不在审核决策链路。  

## 15. Java关键代码（>=5段）
```java
public Decision review(ReviewCmd c){
  if(idemRepo.exists(c.idemKey())) return idemRepo.replay(c.idemKey());
  RuleResult rr = ruleEngine.eval(c);
  Score sc = rr.needModel() ? modelSvc.score(c) : Score.zero();
  return persistDecision(c, rr, sc);
}
```
```java
private Decision persistDecision(ReviewCmd c, RuleResult rr, Score sc){
  tx.begin();
  try{
    Decision d = decisionRepo.save(c.contentId(), rr, sc);
    outbox.append("DECISION_SAVED", d.contentId(), d.toJson());
    tx.commit();
    return d;
  }catch(Exception e){ tx.rollback(); throw e; }
}
```
```java
public void routeCase(Decision d){
  String q = d.riskScore() > 0.9 ? "review.high" : "review.normal";
  mq.send(q, d.contentId(), d.toJson());
}
```
```java
public void retryOrDlq(Event e,int n){
  if(n>=5){ mq.send("review.dlq", e.id(), "max_retry"); return; }
  mq.sendDelay("review.retry", e.id(), (1L<<n)*1000L);
}
```
```java
public void applyAppeal(String contentId, String result){
  Decision latest = decisionRepo.latest(contentId);
  if("APPROVE".equals(result) && !"PASS".equals(latest.decision())){
    decisionRepo.appendVersion(contentId, "PASS", "appeal_override");
  }
}
```

## 16. 前端功能代码（React JS >=2段，仅API协作）
```javascript
import { useState } from "react";
export function ReviewSubmit(){ const [s,setS]=useState("idle");
  const submit=async(p)=>{ setS("loading"); const r=await fetch("/api/v1/moderation/review",{method:"POST",headers:{"Content-Type":"application/json","Idempotency-Key":"k-"+Date.now()},body:JSON.stringify(p)}); setS(r.ok?"done":"error"); };
  return null;
}
```
```javascript
import { useEffect,useState } from "react";
export function CaseQueue(){ const [tip,setTip]=useState("");
  useEffect(()=>{ let t=null; const poll=async()=>{ const r=await fetch("/api/v1/moderation/cases?priority=HIGH"); if(!r.ok) setTip("队列查询失败"); else { const b=await r.json(); if(b.lagMinutes>15) setTip("高峰积压，启用降级策略"); } t=setTimeout(poll,4000);}; poll(); return()=>clearTimeout(t);},[]);
  return null;
}
```

## 17. 测试策略
- 单测：规则匹配、版本决策、申诉回滚。  
- 集成：提审到人审闭环。  
- 压测：10k/s 审核请求。  
- 故障：模型超时、MQ 堆积、人工队列不可用。  

## 18. 丰富例子（>=10）
1. 文本敏感词秒级拦截。  
2. 图片模型超时转人工。  
3. 视频高峰降级抽帧。  
4. 新规则影子模式观测。  
5. 误杀申诉成功回滚。  
6. 高风险队列 SLA 抢占。  
7. 区域合规策略差异。  
8. 重复提审幂等去重。  
9. 死信任务批量回放。  
10. 周报展示误杀下降趋势。  

## 19. 面试追问+可复述回答
- 问：如何控制误杀？答：规则灰度+影子模式+申诉回流。  
- 问：模型超时怎么办？答：熔断降级为规则+人工。  
- 问：如何解释口径变化？答：决策版本化，按版本统计。  

## 20. 新手学习路线
1. 先学规则引擎。  
2. 再学模型编排和队列分级。  
3. 最后学申诉与策略回流。  

## 21. 上场前Checklist
- [ ] 能讲误杀/漏审平衡。  
- [ ] 能讲分级队列。  
- [ ] 能讲申诉回滚。  
- [ ] 能给告警阈值。  
- [ ] 能讲降级策略。  

## 22. 与母题差异（Q93）
- 共性：实时风控、规则+模型、告警。  
- 差异：本题目标是内容合规，不是交易欺诈；强调多模态与人审。  
- 新增知识：审核队列 SLA、申诉流程、策略影子模式、地区合规、误杀治理。  
- 话术：母题是金融欺诈，本题是内容平台治理。  

## 自审评分
- 完整性20/20 易懂性19/20 面试可讲19/20 技术深度19/20 工程落地19/20
总分：96/100（通过）
