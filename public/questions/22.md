# Q22：视频流系统设计（YouTube 类）- 95分面试版

## 1. 三句话题目本质
1. 这题本质上不是“把视频存起来”，而是“让不同网络条件下的用户都能稳定看视频”。  
2. 你要同时解决三条链路：上传链路（能收得住）、转码链路（能处理完）、播放链路（不卡顿）。  
3. 面试高分点在于：ABR（自适应码率）策略、CDN 命中率治理、QoE 观测闭环、以及故障时怎么降级不炸。  

## 2. 一个真实场景故事
你负责一个短视频平台。某天一个大号发了新视频：
- 20 分钟，4K，上传文件 1.8GB。
- 发布后 5 分钟冲上推荐，30 万人同时观看。
- 用户网络环境很复杂：Wi-Fi、4G、弱网地铁、海外漫游都有。

业务方给你的要求很直接：
- 上传后尽快可播，不要等全部清晰度都转完。
- 用户可以接受清晰度波动，但不能接受一直转圈卡死。
- 成本不能无限涨，CDN/转码预算必须可控。

这就是视频流系统的核心现实：体验、稳定、成本三角拉扯。

## 3. 术语白话表（至少 10 项）
| 术语 | 白话解释 | 你在面试里可以怎么说 |
|---|---|---|
| Ingest | 视频接入层，负责接收上传 | “先把大文件稳定收进来” |
| Multipart Upload | 分片上传 | “1.8GB 切成小块，失败只重传坏块” |
| Transcoding | 转码 | “一个原片转成多清晰度版本” |
| ABR | 自适应码率 | “网络好上高清，网络差自动降码率” |
| Manifest | 播放清单文件 | “播放器先拿‘菜单’，再按菜单拉片段” |
| HLS / DASH | 点播分片协议 | “边下边播的行业标准协议” |
| Segment | 视频小片段（2~6秒） | “播放器一次拿一小段，不是整片下载” |
| CDN | 内容分发网络 | “把热点内容缓存到离用户近的节点” |
| QoE | 用户播放体验指标 | “首帧、卡顿、清晰度切换是否平稳” |
| Rebuffer | 播放中断缓冲 | “用户看到转圈圈” |
| DRM | 版权保护机制 | “防盗链、防非法下载和重分发” |
| Origin | 源站 | “CDN 命中不到时回源拿内容” |
| Cache Hit Ratio | 缓存命中率 | “命中越高，回源越少，成本越低” |
| FFmpeg | 常用转码引擎 | “转码流水线核心工具链之一” |
| GOP | 关键帧组 | “影响 seek、码率切换和压缩效率” |

## 4. 需求澄清（功能/非功能/不做范围）
### 4.1 功能需求
- 用户上传视频：支持断点续传、失败重试、进度查询。
- 自动转码：输出 240p / 480p / 720p / 1080p（可扩展 4K）。
- 点播播放：支持 HLS，播放器可自动切码率。
- 视频状态查询：处理中/可播放/失败及失败原因。
- 基础风控：内容审核、版权下架、访问鉴权。

### 4.2 非功能需求（SLO 示例）
- 上传成功率：`>= 99.9%`（按上传会话统计）。
- 首可播时延（上传完成到可播）：`P95 <= 90s`。
- 首帧时间（Start-up Time）：`P95 <= 1.5s`。
- 卡顿率（Rebuffer Ratio）：`<= 2.5%`。
- 整体可用性：`>= 99.95%`。

### 4.3 明确不做（第一版）
- 不做直播（直播链路和点播链路差异大）。
- 不做复杂视频编辑器（剪辑轨道/特效引擎）。
- 不做全球强一致播放计数（计数允许最终一致）。

## 5. 容量估算（含数字推导）
### 5.1 基础假设
- DAU：`30,000,000`
- 每日上传视频数：`2,000,000`
- 平均原片大小：`120MB`
- 每日播放次数：`600,000,000`
- 峰值系数：`8x`（晚高峰+热点叠加）
- 平均观看时长：`6 分钟`
- 平均码率（ABR后综合）：`2 Mbps`

### 5.2 上传侧估算
- 日上传数据量：`2,000,000 * 120MB = 240TB/day`
- 平均上传带宽：`240TB / 86400 ≈ 2.78GB/s ≈ 22.2Gbps`
- 峰值上传带宽（3x）：`~66Gbps`

### 5.3 播放侧估算
- 平均播放 QPS：`600,000,000 / 86400 ≈ 6,944`
- 峰值播放 QPS：`~55,552`
- 若平均并发观看按 6 分钟估算：  
  `并发 ≈ 6,944 * 360s ≈ 2,500,000`
- 出口总带宽粗估：`2,500,000 * 2Mbps = 5Tbps`

结论：没有 CDN 扛不住，源站绝不能直出主流量。

### 5.4 存储估算
- 原片：`240TB/day`
- 转码后多档版本（约原片 1.7 倍）：`~408TB/day`
- 总新增：`~648TB/day`
- 30 天热存：`~19.4PB`

结论：必须冷热分层（热存 + 温存 + 冷存）+ 生命周期管理。

## 6. 架构（简版 + 完整版）
### 6.1 简版架构
```text
客户端上传 -> Ingest -> 对象存储(原片) -> 转码集群 -> 分片/清单 -> CDN -> 播放器
```

### 6.2 完整版架构
```text
[Client Upload SDK]
   -> [Upload API Gateway]
   -> [Upload Session Service] -----> [Metadata DB]
   -> [Object Storage: raw video]
   -> [Event Bus / MQ]
   -> [Transcode Scheduler] -> [Transcode Workers]
   -> [Packager(HLS/DASH)] -> [Object Storage: segments+manifest]
   -> [CDN]
   -> [Player SDK]
   -> [QoE Collector] -> [Streaming Analytics] -> [Metrics/Alert]
```

### 6.3 关键组件职责
- Upload Session Service：分片会话、幂等、状态机。
- Transcode Scheduler：按优先级派发（先低码率后高清）。
- Packager：生成 `m3u8/mpd` 清单和分片路径。
- Player SDK：ABR 决策、错误重试、QoE 上报。
- Streaming Analytics：首帧、卡顿、切码率稳定性计算。

## 7. API 设计（含请求/响应样例）
### 7.1 创建上传会话
`POST /api/v1/videos/upload-sessions`

Request:
```json
{
  "fileName": "trip_4k.mp4",
  "fileSize": 1932735283,
  "checksum": "sha256:xxxx",
  "idempotencyKey": "u_20260224_abc123"
}
```

Response:
```json
{
  "videoId": 98273451,
  "uploadSessionId": "us_4f92",
  "partSize": 8388608,
  "uploadUrls": ["https://...part=1", "https://...part=2"],
  "expiresAt": "2026-02-24T12:00:00Z"
}
```

### 7.2 提交分片完成
`POST /api/v1/videos/{videoId}/parts/complete`

Request:
```json
{
  "uploadSessionId": "us_4f92",
  "partNumber": 7,
  "etag": "etag-value"
}
```

### 7.3 结束上传并触发转码
`POST /api/v1/videos/{videoId}/upload-complete`

Request:
```json
{
  "uploadSessionId": "us_4f92",
  "idempotencyKey": "complete_98273451"
}
```

### 7.4 查询视频处理状态
`GET /api/v1/videos/{videoId}/status`

Response:
```json
{
  "videoId": 98273451,
  "status": "TRANSCODING",
  "profilesReady": ["240p", "480p"],
  "estimatedReadySeconds": 75
}
```

### 7.5 获取播放地址
`GET /api/v1/videos/{videoId}/playback`

Response:
```json
{
  "manifestUrl": "https://cdn.example.com/v/98273451/master.m3u8",
  "drmToken": "jwt-token",
  "expiresInSec": 600
}
```

### 7.6 错误码和限流语义
- `429_TOO_MANY_REQUESTS`：上传会话创建超频。
- `409_SESSION_STATE_CONFLICT`：会话状态非法（已完成又重复完成）。
- `503_TRANSCODE_BACKLOG`：转码队列积压，延迟可播时间。

## 8. 数据模型（核心表/索引）
### 8.1 视频主表
```sql
CREATE TABLE video_asset (
  video_id BIGINT PRIMARY KEY,
  owner_id BIGINT NOT NULL,
  title VARCHAR(256) NOT NULL,
  raw_object_key VARCHAR(512) NOT NULL,
  status VARCHAR(32) NOT NULL, -- INIT/UPLOADING/UPLOADED/TRANSCODING/READY/FAILED/BLOCKED
  duration_ms BIGINT,
  created_at TIMESTAMP NOT NULL,
  updated_at TIMESTAMP NOT NULL
);
CREATE INDEX idx_video_owner_created ON video_asset(owner_id, created_at DESC);
```

### 8.2 上传会话表
```sql
CREATE TABLE upload_session (
  session_id VARCHAR(64) PRIMARY KEY,
  video_id BIGINT NOT NULL,
  state VARCHAR(32) NOT NULL, -- OPEN/COMPLETED/EXPIRED
  part_size INT NOT NULL,
  total_parts INT NOT NULL,
  completed_parts INT NOT NULL DEFAULT 0,
  idempotency_key VARCHAR(128) UNIQUE NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  updated_at TIMESTAMP NOT NULL
);
CREATE INDEX idx_upload_video ON upload_session(video_id);
```

### 8.3 转码任务表
```sql
CREATE TABLE transcode_job (
  job_id BIGINT PRIMARY KEY,
  video_id BIGINT NOT NULL,
  profile VARCHAR(32) NOT NULL, -- 240p/480p/720p/1080p
  priority INT NOT NULL,
  state VARCHAR(32) NOT NULL, -- PENDING/RUNNING/SUCCESS/FAILED
  retry_count INT NOT NULL DEFAULT 0,
  last_error VARCHAR(512),
  updated_at TIMESTAMP NOT NULL,
  UNIQUE(video_id, profile)
);
CREATE INDEX idx_transcode_state_priority ON transcode_job(state, priority DESC, updated_at ASC);
```

### 8.4 播放配置表
```sql
CREATE TABLE playback_profile (
  video_id BIGINT NOT NULL,
  profile VARCHAR(32) NOT NULL,
  bitrate_kbps INT NOT NULL,
  segment_prefix VARCHAR(512) NOT NULL,
  codec VARCHAR(32) NOT NULL,
  PRIMARY KEY(video_id, profile)
);
```

### 8.5 QoE 事件表（可落在 ClickHouse/Druid）
```sql
CREATE TABLE qoe_event (
  event_time TIMESTAMP NOT NULL,
  video_id BIGINT NOT NULL,
  user_id BIGINT,
  startup_ms INT,
  rebuffer_ms INT,
  avg_bitrate_kbps INT,
  cdn_pop VARCHAR(64),
  network_type VARCHAR(16),
  app_version VARCHAR(32)
);
```

## 9. 核心流程（至少 3 条）
### 9.1 正常流程：上传到可播
1. 客户端申请上传会话，拿到分片参数。
2. 客户端分片上传并逐片确认。
3. 完成上传后调用 `upload-complete`，写状态 `UPLOADED`。
4. 事件进入转码队列，先出低码率（240p/480p）。
5. 生成 manifest，CDN 预热热点分片，状态切 `READY`。

### 9.2 高峰流程：热点爆发
1. 某视频播放 QPS 5 分钟内上涨 20x。
2. CDN 命中率下降，回源增高触发 P1 告警。
3. 触发热点预热和多 CDN 调度，回源限速保护源站。
4. 播放器策略临时偏保守码率，降低卡顿。
5. 峰值过后恢复默认策略。

### 9.3 故障恢复流程：转码集群故障
1. 转码 worker 故障导致队列积压上升。
2. 调度器启动“最低可播优先”：只保留 240p/480p 首轮任务。
3. 自动扩容 worker，失败任务指数退避重试。
4. 超过阈值的任务标记人工介入，避免无限重试。
5. 恢复后再补齐高清档位。

### 9.4 补充流程：播放器弱网切码率
1. 客户端检测吞吐降到阈值下方。
2. 立即切低码率并增大缓冲水位目标。
3. 连续 3 个窗口稳定后再尝试升档。

## 10. 一致性与事务边界
### 10.1 强一致部分
- 上传会话状态机必须强约束：不能从 `COMPLETED` 回到 `OPEN`。
- `video_asset.status` 变更要保证单调推进。
- `transcode_job(video_id, profile)` 唯一，避免重复转码。

### 10.2 最终一致部分
- 播放计数、观看时长聚合可延迟分钟级。
- QoE 分析看趋势，不要求事务强一致。

### 10.3 事务设计建议
- 上传完成 + 事件投递：用 Outbox 模式，防止“DB 成功但 MQ 丢消息”。
- 转码完成写库 + 缓存更新：允许最终一致，缓存失效重建。

## 11. 可用性与容错
### 11.1 关键风险
- 上传 API 突刺导致 5xx。
- 转码 backlog 累积，首可播超时。
- CDN 单区域抖动，首帧变慢。
- 播放器新版本 bug 导致卡顿率飙升。

### 11.2 容错策略
- 限流：上传会话创建按用户+IP 双维限流。
- 降级：优先保低码率可播，延后高清转码。
- 隔离：高优先级热视频与普通视频分队列。
- 熔断：异常 CDN POP 熔断并切换备用 POP/CDN。
- 回滚：播放器版本灰度+一键回滚。

### 11.3 RTO / RPO
- RTO：关键服务故障恢复目标 `<= 15 分钟`。
- RPO：元数据 `<= 1 分钟`，QoE 聚合允许 `<= 10 分钟` 延迟。

## 12. 可观测性（指标 + 告警阈值）
### 12.1 上传链路
- `upload_success_rate_5m < 99.5%` -> P1
- `upload_complete_p95 > 120s` -> P2

### 12.2 转码链路
- `transcode_queue_lag_minutes > 20` -> P1
- `transcode_fail_rate_5m > 3%` -> P1
- `first_playable_time_p95 > 90s` -> P1

### 12.3 播放链路
- `startup_time_p95 > 1.5s` -> P1
- `rebuffer_ratio > 2.5%` 持续 10 分钟 -> P1
- `cdn_hit_ratio < 85%` 持续 5 分钟 -> P1

### 12.4 值班处置 Runbook（简版）
1. 先判定影响面：地区 / 运营商 / App 版本。
2. 判断是 CDN 问题还是播放器问题还是源站问题。
3. 先做止血动作（切 CDN、降码率、限上传突刺）。
4. 再做根因和修复，最后回补数据与复盘。

## 13. 安全与合规
- 鉴权：播放 URL 使用短时签名 token，防盗链。
- 版权：DRM（Widevine/FairPlay）和黑名单下架能力。
- 内容合规：上传后进入审核队列，违规内容阻断分发。
- 数据保护：用户隐私字段脱敏，日志不打明文凭证。
- 审计：关键操作（下架、封禁、回滚）保留审计日志。

## 14. 成本与取舍
### 14.1 成本大头
- 转码计算（GPU/CPU）。
- 存储（原片+多档分片）。
- CDN 出口带宽。

### 14.2 降本策略
- 按需转码：长尾视频先生成低码率，高清按需触发。
- 生命周期分层：30 天热存，90 天温存，长期冷存。
- 编码优化：HEVC/AV1 在部分终端开启，节省带宽。
- CDN 策略：热点预热、合理 TTL、减少回源穿透。

### 14.3 取舍表达（面试常用）
- “更低首帧时间”通常意味着“更高预热和缓存成本”。
- “更高画质覆盖”通常意味着“更高转码和带宽成本”。
- 你要明确平台阶段：增长期偏体验，利润期偏成本。

## 15. Java 关键代码（至少 4 段，点位不同）
### 15.1 上传完成幂等 + Outbox 投递
```java
public class UploadCompleteService {
    public void complete(long videoId, String sessionId, String idempotencyKey) {
        if (idemRepo.exists("UPLOAD_COMPLETE", idempotencyKey)) {
            return; // 幂等保护
        }

        Transaction tx = txManager.begin();
        try {
            UploadSession session = sessionRepo.lockById(sessionId);
            if (!"OPEN".equals(session.getState())) {
                throw new IllegalStateException("invalid session state");
            }

            sessionRepo.markCompleted(sessionId);
            videoRepo.updateStatus(videoId, "UPLOADED");
            outboxRepo.insert("VIDEO_UPLOADED", String.valueOf(videoId));
            idemRepo.save("UPLOAD_COMPLETE", idempotencyKey);
            tx.commit();
        } catch (RuntimeException ex) {
            tx.rollback();
            throw ex;
        }
    }
}
```

### 15.2 转码调度（先低清优先）
```java
public class TranscodeScheduler {
    private static final List<String> PROFILE_ORDER = List.of("240p", "480p", "720p", "1080p");

    public void onVideoUploaded(long videoId) {
        int priorityBase = 1000;
        for (int i = 0; i < PROFILE_ORDER.size(); i++) {
            String profile = PROFILE_ORDER.get(i);
            int priority = priorityBase - (i * 100); // 240p 优先级最高
            if (!jobRepo.exists(videoId, profile)) {
                jobRepo.create(videoId, profile, priority);
            }
        }
    }

    public Optional<TranscodeJob> pollJob(String workerId) {
        return jobRepo.pollNextPending(workerId);
    }
}
```

### 15.3 播放器 ABR 策略（吞吐+缓冲双信号）
```java
public class AbrEngine {
    public String selectProfile(int throughputKbps, int bufferMs, String current) {
        if (bufferMs < 2500) return "240p";
        if (throughputKbps < 1400) return "480p";
        if (throughputKbps < 2800) return "720p";
        if (bufferMs > 6000) return "1080p";
        return current; // 避免频繁抖动切换
    }
}
```

### 15.4 QoE 聚合与告警触发
```java
public class QoeAggregator {
    public void ingest(QoeEvent e) {
        qoeRepo.insert(e);
        metrics.timer("startup_ms").record(e.getStartupMs(), TimeUnit.MILLISECONDS);
        metrics.summary("rebuffer_ms").record(e.getRebufferMs());
    }

    public void evaluateWindow(QoeWindow w) {
        if (w.getRebufferRatio() > 0.025 && w.getDurationMinutes() >= 10) {
            alertService.fireP1("rebuffer ratio high", w.toMap());
        }
        if (w.getStartupP95Ms() > 1500) {
            alertService.fireP1("startup p95 high", w.toMap());
        }
    }
}
```

### 15.5 CDN 异常切换（多 CDN）
```java
public class CdnRouter {
    public String chooseDomain(String region, double hitRatio, double errorRate) {
        if (errorRate > 0.03 || hitRatio < 0.80) {
            return "https://cdn-b.example.com";
        }
        return "https://cdn-a.example.com";
    }
}
```

## 16. 测试策略
### 16.1 单元测试
- 上传会话状态机：非法状态跳转必须失败。
- ABR 决策：不同吞吐/缓冲输入下输出稳定可预测。
- 转码任务去重：同 `videoId+profile` 重复入队不产生重复任务。

### 16.2 集成测试
- 上传完成 -> Outbox -> MQ -> 转码 -> READY 全链路。
- CDN 回源异常时，域名切换是否生效。
- DRM token 过期与刷新流程。

### 16.3 压测
- 上传突刺：5 分钟冲到 3 倍峰值。
- 热点播放：单视频并发拉到 100 万会话。
- 转码灾难：模拟 worker 30% 下线，看 backlog 恢复时间。

### 16.4 故障演练
- 关闭一个转码可用区，验证 RTO。
- 指定地区 CDN 故障，验证切流耗时。
- 播放器发布错误版本，验证灰度熔断与回滚。

## 17. 丰富例子（至少 10 个）
1. 用户上传到 82% 断网，恢复网络后从第 145 个分片继续传，不从头开始。  
2. 2GB 视频上传完后 45 秒先可播 480p，1080p 在后台慢慢补齐。  
3. 地铁弱网下播放器从 720p 降到 240p，画面糊一点但不中断。  
4. 爆款视频发布 10 分钟内播放量暴涨，CDN 预热让回源从 35% 降到 8%。  
5. 某地区 CDN 节点抖动，切到备用 CDN 后首帧从 2.8s 恢复到 1.3s。  
6. 转码任务失败 3 次后进入死信队列，人工排查是源文件损坏。  
7. 版权投诉触发下架，60 秒内所有播放链接返回“不可播放”。  
8. 新版播放器 ABR bug 导致频繁抖动切换，灰度回滚 5 分钟止血。  
9. 长尾视频只保留 480p，月度存储成本下降 22%。  
10. 某机型 DRM 解密失败，按设备黑名单切非 DRM 预览（受限清晰度）。  
11. 节假日峰值来临前预扩容转码池，避免 upload-to-ready 指标超阈。  
12. 用户在海外访问，DNS 调度到就近 POP，启动时延下降 40%。  

## 18. 面试追问 + 可复述回答
### Q1：为什么不用“单码率文件”？
可复述答法：  
“单码率在弱网场景会频繁卡顿。多码率 + ABR 才能在不同网络下平衡清晰度和流畅度，这是视频体验的底线。”

### Q2：首可播时间怎么优化？
可复述答法：  
“低码率优先转码，先让用户播起来；高清档异步补齐。并行打包清单，减少状态切换等待。”

### Q3：CDN 命中率低怎么查？
可复述答法：  
“先按地域/运营商/URL 分层看命中；再查 TTL、热点预热、分片命名是否导致碎片化；必要时多 CDN 切流止血。”

### Q4：如何避免重复转码浪费？
可复述答法：  
“任务唯一键 `videoId+profile`，调度前查重；消费者幂等；失败用有限重试+死信，不做无限重试。”

### Q5：如何定义系统是否健康？
可复述答法：  
“看 QoE：首帧 P95、卡顿率、播放完成率；再看支撑指标：CDN 命中率、转码队列积压、失败率。”

### Q6：怎么平衡体验和成本？
可复述答法：  
“分用户价值和内容热度分层，热门全档保障体验，长尾按需转码保障成本，持续用实验数据调参数。”

## 19. 新手学习路线（从零到能讲清）
### 第 1 周：打基础
- 理解 HLS 结构：`master.m3u8`、variant、segment 的关系。
- 手动用 FFmpeg 做一个视频多码率输出。
- 搭一个最小播放器，跑通分片播放。

### 第 2 周：做上传和转码队列
- 实现分片上传与断点续传。
- 实现上传会话状态机和幂等键。
- 接入 MQ，把转码做成异步任务。

### 第 3 周：做 ABR 和观测
- 实现简化 ABR 决策（吞吐+缓冲）。
- 上报 QoE 事件，做 Grafana 看板。
- 设置首帧、卡顿、命中率告警。

### 第 4 周：做面试化表达
- 按“需求-估算-架构-流程-容错-成本”讲 10 分钟版本。
- 准备 5 个故障案例与止血动作。
- 练 30 秒总结和 3 分钟高压快答。

## 20. 上场前 Checklist
- [ ] 我能在 1 分钟讲清“上传、转码、播放”三条链路。  
- [ ] 我能解释 ABR 为什么是体验核心，而不是“锦上添花”。  
- [ ] 我能给出至少 3 个 QoE 指标和具体告警阈值。  
- [ ] 我能说出“CDN 命中率下滑”的排查路径和止血动作。  
- [ ] 我能解释低码率优先转码背后的取舍。  
- [ ] 我能讲明白幂等、重试、死信队列的边界。  
- [ ] 我能描述一次真实故障演练（触发-止血-恢复-复盘）。  
- [ ] 我能把成本优化讲成可量化收益，而不是口号。  

## 21. 30 秒总结
视频流系统的高分答案是：  
“我先保证上传稳，再让低码率尽快可播，播放阶段用 ABR 保流畅，用 CDN 扛流量，用 QoE 闭环持续优化；故障时先止血再恢复，最后把体验与成本取舍讲清楚。”  
只要你能把这句话展开成完整链路，并给出阈值、流程和代码点位，面试官会认为你有落地能力。  
