# Q14 Design Social Network - 社交网络（高频）

## 1. 三句话题目本质
1. 这题是“关系图 + 内容发布 + Feed 分发 + 隐私权限”的综合社交系统。  
2. 难点是写扩散（发帖触达粉丝）和读放大（拉时间线）之间的平衡。  
3. 面试关键是把关系、内容、分发、审核、隐私五条链路讲成一体。  

## 2. 一个真实场景故事
你做一个泛社交产品，月活从 100 万涨到 3000 万。最初统一 fan-out-on-write，大 V 发帖触发 5000 万粉丝写扩散，队列瞬间积压。你改成“普通用户 push、大 V pull、热点混合缓存”，再叠加内容审核和隐私过滤，系统稳定下来，用户时间线延迟从秒级抖动收敛到可控。  

## 3. 术语白话表（新手可懂）
1. Follow Graph：关注关系图。  
2. Feed：用户时间线内容流。  
3. Fan-out on Write：发帖时把内容推给粉丝。  
4. Fan-out on Read：读时间线时再聚合内容。  
5. Hybrid Feed：混合模式（普通 push、大 V pull）。  
6. Timeline Cache：每个用户的时间线缓存。  
7. Privacy Filter：隐私过滤器。  
8. Moderation：内容审核（机器+人工）。  
9. Ranking：对候选内容排序。  
10. Backfill：补拉历史内容。  
11. Shadow Ban：影子封禁，不显式提示。  
12. Edge Cache：边缘缓存，减少回源。  

## 4. 需求澄清（功能/非功能/不做范围/SLO）
### 4.1 功能需求
1. 用户关注/取关。  
2. 发帖、删帖、转发、点赞、评论。  
3. 首页时间线读取（含分页）。  
4. 隐私设置（仅粉丝、仅好友、公开）。  
5. 内容审核与违规处理。  

### 4.2 非功能需求
1. 高并发读写。  
2. 大 V 场景稳定分发。  
3. 低延迟时间线返回。  
4. 审核与隐私合规可追溯。  

### 4.3 不做范围
1. 不做实时音视频通话。  
2. 不做广告 RTB 竞价。  
3. 不做复杂推荐模型训练细节。  

### 4.4 SLO/SLA
1. 发帖接口 P95 < 120ms。  
2. 首页时间线 P95 < 200ms。  
3. Feed 服务可用性 >= 99.95%。  

## 5. 容量估算（数字推导）
假设 DAU 3000 万，日发帖 9000 万，读写比约 50:1：  
1. 发帖平均 QPS ≈ 1042，峰值按 8 倍 ≈ 8300。  
2. 时间线读平均 QPS ≈ 5.2 万，峰值可达 40 万。  
3. 若每条帖子元数据 1KB，日新增约 86GB。  
4. 大 V 占用户 0.1%，却贡献 40% 阅读流量。  
5. Feed 缓存要按热点用户单独扩容。  

## 6. 架构设计（简版+完整版）
### 6.1 简版
`关系服务 -> 发帖服务 -> 分发服务 -> Feed缓存 -> 时间线API`

### 6.2 完整版
1. User Graph Service：关注关系存储与查询。  
2. Post Service：内容创建、删除、版本。  
3. Feed Fanout Service：push/pull 混合分发。  
4. Timeline Read Service：聚合、分页、去重、排序。  
5. Privacy Service：可见性策略判定。  
6. Moderation Pipeline：审核打标与下线。  
7. Cache Layer：用户时间线缓存 + 热帖缓存。  
8. Analytics：活跃、互动、分发延迟监控。  

## 7. API 设计（请求/响应/错误码/幂等）
1. `POST /v1/social/follow`  
2. `POST /v1/social/posts`  
3. `GET /v1/social/feed?cursor=`  
4. `POST /v1/social/posts/{id}/like`  
5. `POST /v1/social/privacy/rule`  

发帖请求示例：
```json
{
  "authorId": 1001,
  "text": "今天发布新功能",
  "visibility": "FOLLOWERS",
  "idempotencyKey": "post-1001-20260224-001"
}
```

时间线响应示例：
```json
{
  "items": [{"postId":"p_1","authorId":2002,"score":0.98}],
  "nextCursor": "c_7788"
}
```

错误码：`403_PRIVACY_DENIED`、`429_FEED_THROTTLED`、`451_CONTENT_BLOCKED`、`503_FANOUT_DELAYED`。  

## 8. 数据模型（实体、索引、分片分区）
1. `follow_edge`：`src_user`、`dst_user`、`state`。  
2. `post`：`post_id`、`author_id`、`content_uri`、`visibility`、`status`。  
3. `feed_item`：`user_id`、`post_id`、`score`、`created_at`。  
4. `privacy_rule`：`user_id`、`rule_type`、`rule_value`。  
5. `moderation_tag`：`post_id`、`risk_level`、`action`。  
6. 索引：`idx_feed_user_time(user_id,created_at desc)`。  
7. 分片：按 `user_id` 分片，热点作者独立分片。  

## 9. 核心流程（正常/高峰/故障恢复）
1. 正常：发帖 -> 审核预判 -> 分发 -> 缓存更新 -> 粉丝读 feed。  
2. 高峰：大 V 发帖 -> 走 pull 模式，避免写扩散洪峰。  
3. 故障恢复：分发服务异常 -> 入队重试 -> 读路径回退到 pull 聚合。  

## 10. 一致性与事务边界
1. 发帖成功与分发可异步，允许短暂延迟。  
2. 隐私规则变更要优先生效，读路径必须过滤。  
3. 审核下线后需要回收缓存并更新时间线。  
4. 互动计数可最终一致，核心内容可见性不放松。  

## 11. 可用性与容错
1. 分发链路异步化，避免同步阻塞。  
2. 熔断：审核服务故障时进入“仅白名单可发”保护模式。  
3. 降级：推荐排序不可用时按时间倒序返回。  
4. 缓存失效风暴时启用请求合并与热点保护。  
5. RTO 20 分钟，RPO 5 分钟。  

## 12. 可观测性（指标+阈值+处置）
关键指标：  
1. `post_success_rate`  
2. `fanout_lag_ms`  
3. `feed_read_p95_ms`  
4. `privacy_filter_drop_rate`  
5. `moderation_block_rate`  

告警阈值：  
1. 发帖成功率 < 98%（10分钟）-> P1。  
2. 分发延迟 P95 > 5000ms（10分钟）-> P1。  
3. feed 查询 P95 > 300ms（10分钟）-> P1。  
4. 隐私过滤异常下降 50%（10分钟）-> P1（怀疑策略失效）。  

处置：限流 -> 切读降级 -> 关闭高成本排序 -> 分发补偿重放。  

## 13. 安全与合规
1. 用户隐私规则强制前置。  
2. 内容审核链路可追溯（机器判定+人工复核）。  
3. 反垃圾与反骚扰策略（频率、文本、关系）。  
4. 敏感操作审计日志保留。  
5. 支持数据删除请求与合规导出。  

## 14. 成本与取舍
1. 全 push 模式实时但成本高；全 pull 模式省写但读延迟高。  
2. 混合分发复杂，但对大规模社交最实用。  
3. 审核越严格越安全但误杀风险增加。  
4. 缓存越激进越快，但一致性维护成本上升。  

## 15. Java 关键代码（贴题难点，充分细节）
### 15.1 混合分发策略
```java
public class FanoutStrategy {
    public Mode choose(long authorFollowerCount) {
        if (authorFollowerCount < 50_000) return Mode.PUSH;
        return Mode.PULL; // 大V走PULL，避免写扩散风暴
    }
}
```

### 15.2 发帖幂等与状态流转
```java
public class PostService {
    public String create(PostReq req, PostRepo repo) {
        if (repo.existsByIdem(req.idempotencyKey())) return repo.findIdByIdem(req.idempotencyKey());
        String id = Ids.next();
        repo.insert(id, req.authorId(), req.text(), "PENDING_REVIEW", req.idempotencyKey());
        return id;
    }
}
```

### 15.3 时间线读取聚合
```java
public class TimelineService {
    public List<FeedItem> read(long userId, String cursor, int size, FeedRepo repo, PrivacyFilter filter) {
        List<FeedItem> raw = repo.fetchByCursor(userId, cursor, size * 2);
        return raw.stream().filter(filter::allow).limit(size).toList();
    }
}
```

### 15.4 隐私规则过滤
```java
public class PrivacyFilter {
    public boolean allow(FeedItem item, ViewerContext viewer) {
        if ("PUBLIC".equals(item.visibility())) return true;
        if ("FOLLOWERS".equals(item.visibility())) return viewer.following(item.authorId());
        if ("FRIENDS".equals(item.visibility())) return viewer.friend(item.authorId());
        return false;
    }
}
```

### 15.5 分发补偿任务
```java
public class FanoutCompensationJob {
    public void replay(List<PostEvent> failedEvents, FanoutWriter writer) {
        for (PostEvent e : failedEvents) {
            try { writer.write(e); } catch (Exception ex) { /* record retry */ }
        }
    }
}
```

## 16. 前端功能代码（贴题控制台/运营页）
### 16.1 Feed 运营看板（React + TS）
```tsx
type FeedMetric = { fanoutLagMs: number; readP95Ms: number; postSuccessRate: number };

export function FeedOpsDashboard() {
  const [m, setM] = useState<FeedMetric | null>(null);
  useEffect(() => { fetch("/api/social/metrics").then(r => r.json()).then(setM); }, []);
  if (!m) return <div>loading...</div>;
  return <div>分发延迟:{m.fanoutLagMs}ms 读P95:{m.readP95Ms}ms 发帖成功率:{m.postSuccessRate}%</div>;
}
```

### 16.2 隐私规则配置页（React + TS）
```tsx
export function PrivacySettingPage() {
  const [visibility, setVisibility] = useState("FOLLOWERS");
  async function save() {
    await fetch("/api/social/privacy/rule", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ visibility })
    });
    alert("隐私设置已更新");
  }
  return (
    <div>
      <select value={visibility} onChange={e => setVisibility(e.target.value)}>
        <option value="PUBLIC">公开</option>
        <option value="FOLLOWERS">仅粉丝</option>
        <option value="FRIENDS">仅好友</option>
      </select>
      <button onClick={save}>保存</button>
    </div>
  );
}
```

## 17. 测试策略
1. 单测：分发策略、隐私过滤、幂等发帖。  
2. 集成：发帖->审核->分发->时间线读取全链路。  
3. 压测：大 V 发帖和热点 feed 读取。  
4. 故障演练：分发延迟、审核故障、缓存雪崩。  
5. 安全测试：隐私绕过、违规内容漏拦截。  

## 18. 丰富例子（面试可复述）
1. 大 V 发帖如何避免写扩散雪崩。  
2. 用户改为“仅好友可见”如何立即生效。  
3. 审核系统故障时发帖策略怎么降级。  
4. feed 读延迟升高怎么排查。  
5. 缓存命中下降如何恢复。  
6. 互动量暴涨时计数一致性怎么做。  
7. 用户投诉看到了不该看的内容怎么追溯。  
8. 长尾用户 feed 为空如何补内容。  
9. 分发消息重复消费怎么处理。  
10. 删除帖子后历史 feed 如何清理。  
11. 跨机房同步延迟对 feed 的影响。  
12. 隐私规则误配置如何回滚。  

## 19. 面试追问+回答模板
1. 问：为什么不用纯 push？  
答：大 V 粉丝太多会造成写风暴，混合分发更稳。  
2. 问：如何保证隐私不穿透？  
答：读路径统一隐私过滤前置，策略变更走高优先级发布。  
3. 问：审核和分发冲突怎么处理？  
答：先审后发，已发后命中违规需回收与二次通知。  

## 20. 新手学习路线
1. 先学关系图建模。  
2. 学 push/pull 分发模式。  
3. 学缓存与排序策略。  
4. 学隐私与审核规则。  
5. 学故障演练和补偿机制。  

## 21. 上场前Checklist
1. 能讲清混合分发场景。  
2. 能讲清隐私过滤位置。  
3. 能给出分发延迟阈值。  
4. 能讲清审核回收流程。  
5. 能讲出与母题差异。  

## 22. 与母题差异（共性/差异/新增知识/话术）
### 22.1 对应母题
- 母题：`Q2 Twitter Timeline - 推特时间线与搜索`。  

### 22.2 共性能力
1. 都是社交 feed 核心系统。  
2. 都有关系图和分发问题。  
3. 都关注大 V 热点。  
4. 都需要缓存与排序。  

### 22.3 关键差异
1. Q2 更聚焦时间线与搜索；Q14 是社交网络全链路（关系+内容+隐私+审核）。  
2. Q14 更强调隐私规则与内容治理。  
3. Q14 包含更多互动与运营能力。  
4. Q2 常用作 feed 母题，Q14 更像扩展版产品化系统。  
5. Q14 的安全合规要求更完整。  

### 22.4 本题新增必补知识
1. 社交隐私规则系统化设计。  
2. 审核流水线与回收机制。  
3. 互动行为与关系联动。  
4. 多种可见性策略执行。  
5. 运营看板与治理策略。  

### 22.5 面试差异话术
1. “Q2 是 feed 核心机制，Q14 是完整社交产品系统。”  
2. “答 Q14 要把隐私和审核讲透，不止分发模型。”  
3. “Q14 更强调合规和治理，不只是性能优化。”  
