# Q55 Design Image Hosting Service

> 来源校验（questions.ts）  
> `title`: Design Image Hosting Service  
> `tags`: 对象存储, 图片处理, CDN, 去重, 缩略图  
> `keyPoints`: 对象存储, 图片压缩, 缩略图生成, CDN加速, 图片去重  
> `learningCoreId`: 22（母题：视频流系统）

## 1. 三句话题目本质
1. 这题本质是“提供一个可外部使用的图片存储与分发服务”。
2. 难点是上传可靠性、转换处理、访问控制、CDN 缓存和成本。
3. 高分回答要体现产品化 API、按需变换、热冷分层和计费治理。

## 2. 一个真实场景故事
一个电商 SaaS 平台把商家图片托管开放给第三方，日请求 20 亿次。初期所有变换同步处理导致源站爆满。后来改成“原图存储 + 热门变体预生成 + 冷门按需生成并缓存”，源站流量下降 65%，加载速度明显改善。

## 3. 术语白话表（>=10）
1. Original Object：原图对象。
2. Variant：变换后图片版本（尺寸/格式/水印）。
3. On-the-fly Transform：按请求实时变换。
4. Pre-generate：预生成常用规格。
5. Signed URL：签名访问链接。
6. Token TTL：访问令牌有效期。
7. Content Hash：内容哈希去重键。
8. Cache Stampede：同一变体并发回源风暴。
9. Origin Shield：源站保护层。
10. Lifecycle Tiering：冷热分层策略。
11. Egress Cost：外网流量成本。
12. Soft Quota：软配额限流。

## 4. 需求澄清（功能/非功能/不做范围/SLO）
### 4.1 功能需求
1. 提供上传、获取、删除图片 API。
2. 支持动态变换（resize/format/watermark）。
3. 支持公开链接和私有鉴权链接。
4. 支持去重与版本管理。
5. 支持访问统计和账单计量。

### 4.2 非功能需求
1. 高可用与低延迟访问。
2. 高并发上传与下载。
3. 成本可控。
4. 数据安全与合规。

### 4.3 不做范围
1. 不做视频处理能力。
2. 不做复杂图像编辑器。
3. 不做 AI 生成图像。

### 4.4 SLO
1. 上传成功率 >= 99.95%。
2. 图片读取 P95 <= 150ms（CDN 命中）。
3. 变换生成 P95 <= 2s（首次）。

## 5. 容量估算（数字推导）
1. 日上传 5000 万张，平均 250KB，原图约 12.5TB/day。
2. 常用变体 2.5 倍请求量，热门变体缓存命中目标 90%。
3. 按 30 天热存，原图约 375TB（不含副本）。
4. 冷数据 180 天归档对象存储低价层。
5. 峰值读取 80 万 RPS，需 CDN 多 POP。
6. 结论：变体缓存、热冷分层和回源保护是刚需。

## 6. 架构（简版+完整版）
### 6.1 简版
`Client -> Upload API -> Object Storage -> CDN -> Transform Service`

### 6.2 完整版
1. Upload Service：签发上传 URL、落元数据。
2. Object Storage：存原图和变体。
3. Transform Service：按需或预生成变体。
4. CDN：全局加速和缓存。
5. Metadata Service：记录对象、版本、权限、hash。
6. Billing Pipeline（MQ）：访问计量与账单。
7. Security Service：签名、鉴权、防盗链。
8. Lifecycle Worker：冷热迁移和过期清理。

## 7. API 设计（请求/响应/错误码/幂等）
### 7.1 获取上传地址
`POST /api/image-host/v1/upload-url`

响应：
```json
{
  "imageId": "img_9001",
  "uploadUrl": "https://obj/...sig=...",
  "expiresInSec": 600
}
```

### 7.2 获取图片
`GET /api/image-host/v1/images/{imageId}?w=400&fmt=webp`

### 7.3 删除图片
`DELETE /api/image-host/v1/images/{imageId}`

错误码：
1. `401_SIGNATURE_INVALID`
2. `404_IMAGE_NOT_FOUND`
3. `409_IMAGE_LOCKED`
4. `429_QUOTA_EXCEEDED`

幂等规则：
1. 上传完成回调用 `uploadId` 幂等。
2. 删除接口用 `requestId` 幂等。

## 8. 数据模型（实体/索引/分片）
1. `image_object(image_id, owner_id, hash, origin_key, state, created_at)`。
2. `image_variant(image_id, variant_key, object_key, size, format, hit_count)`。
3. `access_token(token_id, image_id, expire_at, scope)`。
4. `billing_event(event_id, owner_id, image_id, bytes_out, ts)`。
5. `image_audit(audit_id, actor, action, target, ts)`。

冷热与分片：
1. 热门 image/variant 放 Redis 元数据缓存。
2. 冷门对象仅对象存储查元数据。
3. 历史计费事件按月冷归档。

## 9. 核心流程（正常/高峰/故障恢复）
### 9.1 正常流程
1. 客户端拿上传 URL 并直传对象存储。
2. 完成回调后写元数据并触发预生成任务。
3. 读取请求先走 CDN，miss 时回源生成/拉取变体。

### 9.2 高峰流程
1. 热门变体提前预生成。
2. 变换请求做 single-flight 防止同图重复计算。
3. 对超大图请求限流，优先保障常规规格。

### 9.3 故障恢复流程
1. Transform 服务故障时回退原图直出。
2. 对象存储区域故障切备用桶。
3. 计费 MQ 积压时先写本地缓冲后补发。

## 10. 一致性与事务边界
1. 对象落地与元数据最终一致。
2. 上传成功后才允许公开访问。
3. 计费事件异步一致，按 `event_id` 去重。
4. 删除采用软删->异步物理删。
5. 变体可重建，原图不可丢。

## 11. 可用性与容错（含 RTO/RPO）
1. 多区域对象存储复制。
2. CDN 多节点容灾。
3. 变换服务无状态多副本。
4. RTO：读取能力 10 分钟恢复。
5. RPO：原图 0 丢失目标，变体可重建。

## 12. 可观测性（指标+阈值+处置动作）
1. `cdn_hit_ratio < 90%`：优化缓存键与 TTL。
2. `transform_p95_ms > 2000`：扩容变换服务并开启预生成。
3. `origin_5xx_rate > 1%`：启用 origin shield。
4. `upload_success_rate < 99.95%`：排查签名和对象存储。
5. `egress_cost_daily` 超预算：压缩策略和格式策略调整。
6. `dedup_miss_rate` 异常：排查 hash 逻辑。

## 13. 安全与合规
1. 私有图片必须签名访问。
2. Token 最短有效期原则。
3. 防盗链 Referer/签名校验。
4. 敏感图像访问审计。
5. 删除请求合规执行与追踪。

## 14. 成本与取舍
1. 预生成多规格提升性能但增加存储。
2. 实时变换节省存储但增加 CPU。
3. WebP/AVIF 降带宽但编码成本高。
4. 取舍：热门预生成、冷门按需生成。

## 15. Java 关键代码（>=5段）
### 15.1 核心算法：变体 key 生成（状态转移）
```java
public String buildVariantKey(String imageId, int w, String fmt, String watermark) {
    String spec = w + "|" + fmt + "|" + (watermark == null ? "-" : watermark);
    return imageId + ":" + Digest.sha1(spec);
}
```

### 15.2 幂等去重：上传完成
```java
public void completeUpload(String uploadId, String imageId, String originKey) {
    if (uploadRepo.isDone(uploadId)) return;
    uploadRepo.markDone(uploadId);
    metaRepo.upsertOrigin(imageId, originKey, "READY");
}
```

### 15.3 重试退避/失败处理：按需变换
```java
public String transformWithRetry(String imageId, VariantReq req) {
    long wait = 100;
    for (int i = 0; i < 3; i++) {
        try { return transformer.generate(imageId, req); }
        catch (RuntimeException ex) {
            if (i == 2) throw ex;
            sleep(wait);
            wait = Math.min(wait * 2, 1000);
        }
    }
    throw new IllegalStateException("unreachable");
}
```

### 15.4 一致性边界：软删+outbox
```java
@Transactional
public void softDelete(String imageId, String actor) {
    metaRepo.markDeleted(imageId);
    auditRepo.insert(actor, "SOFT_DELETE", imageId);
    outboxRepo.insert("IMAGE_DELETE", imageId);
}
```

### 15.5 观测触发/回滚判定
```java
public void guardCostAndLatency() {
    double hit = metrics.gauge("cdn_hit_ratio").value();
    if (hit < 0.90) cachePolicy.increaseTtlForHot();
    long p95 = metrics.gauge("transform_p95_ms").longValue();
    if (p95 > 2000) pregenService.enableHotVariantMode();
}
```

## 16. 前端功能代码（React JS，仅 API 协作）
### 16.1 上传 API 流程（loading/error/done）
```javascript
import { useState } from "react";

export function useImageHostUpload() {
  const [state, setState] = useState({ phase: "idle", imageId: "", error: "" });
  async function upload(file) {
    setState({ phase: "loading", imageId: "", error: "" });
    try {
      const u = await fetch("/api/image-host/v1/upload-url", { method: "POST" });
      if (!u.ok) throw new Error(`HTTP_${u.status}`);
      const token = await u.json();
      const put = await fetch(token.uploadUrl, { method: "PUT", body: file });
      if (!put.ok) throw new Error(`UPLOAD_${put.status}`);
      setState({ phase: "done", imageId: token.imageId, error: "" });
    } catch (e) {
      setState({ phase: "error", imageId: "", error: String(e.message || e) });
    }
  }
  return { state, upload };
}
```

### 16.2 删除 API（幂等+重试）
```javascript
export async function deleteHostedImage(imageId) {
  const reqId = `del-${Date.now()}-${Math.random().toString(16).slice(2)}`;
  let delay = 100;
  for (let i = 0; i < 3; i++) {
    try {
      const res = await fetch(`/api/image-host/v1/images/${imageId}`, {
        method: "DELETE",
        headers: { "X-Request-Id": reqId }
      });
      if (!res.ok) throw new Error(`HTTP_${res.status}`);
      return { ok: true };
    } catch (err) {
      if (i === 2) return { ok: false, error: String(err.message || err) };
      await new Promise((r) => setTimeout(r, delay));
      delay = Math.min(delay * 2, 800);
    }
  }
}
```

## 17. 测试策略
1. 单元测试：变体生成、签名校验、去重逻辑。
2. 集成测试：上传->处理->分发->计费。
3. 压测：读取高峰与变换高峰。
4. 故障测试：CDN 故障、对象存储抖动、MQ 积压。
5. 回归测试：访问控制与删除合规。

## 18. 丰富例子（>=10）
1. 商家上传产品图并秒级可访问。
2. 首次请求 400w 触发按需生成。
3. 热门规格预生成提高命中。
4. 私有图片仅签名 URL 可读。
5. 变换失败回退原图。
6. 重复图片 hash 去重。
7. 删除后 CDN purge 清缓存。
8. 日账单统计下载流量。
9. 低访问图片转冷存。
10. 夜间批量预热热门图片。
11. 盗链请求被拒绝。
12. 异常成本增长触发压缩策略。

## 19. 面试追问 + 可复述回答
1. 为什么需要产品化 API？
回答：这是托管服务，要支持第三方集成和权限隔离。
2. 实时变换和预生成怎么选？
回答：热门预生成，冷门按需，综合性能和成本。
3. 为什么必须有 MQ 计费？
回答：计费异步化不阻塞读取链路，且可回放。
4. CDN 不命中怎么办？
回答：回源并单飞生成，避免变换风暴。
5. 与视频母题差异？
回答：图片托管更偏静态对象服务和变体管理。

## 20. 新手学习路线
1. 先实现上传+读取基本链路。
2. 增加变体生成能力。
3. 接入 CDN 和签名权限。
4. 加计费和冷热分层。
5. 做高峰压测和成本优化。

## 21. 上场前 Checklist
1. 能讲清上传与读取链路。
2. 能解释预生成与按需变换。
3. 能说明 CDN 与回源保护。
4. 能给出成本阈值和动作。
5. 能区分 Q55 与 Q22。

## 22. 与母题差异（对应母题/共性/差异/新增知识/话术）
### 22.1 对应母题
Q22 视频流系统。

### 22.2 共性能力
1. 媒体存储与分发。
2. CDN 加速与缓存治理。
3. 异步处理流水线。

### 22.3 关键差异
1. Q22 重播放链路；Q55 重对象托管 API。
2. Q55 更强调变体与签名访问。
3. Q55 更强调计费和多租户。
4. Q22 强调码率适配；Q55 强调图片规格变换。
5. Q55 读取模式更接近静态资源服务。

### 22.4 本题新增知识点（>=5）
1. 产品化上传/读取 API 设计。
2. 变体键设计与缓存策略。
3. 访问签名与防盗链。
4. 下载计费事件流水。
5. 热冷对象生命周期策略。
6. 单飞防变换风暴。

### 22.5 面试差异话术
“Q22 是视频平台题，Q55 是图片托管服务题；55 的核心是 API 产品化、变体管理、鉴权和成本运营。”

---

## 单题自审（Q55）
### A. 完整性检查
1. 22 节完整：通过。
2. Java 代码段 5 段：通过。
3. React JS API 代码 2 段：通过。

### B. 易懂性检查
1. 术语白话 >=10：通过。
2. 正常/高峰/故障流程完整：通过。

### C. 专属性检查
1. 聚焦图片托管服务：通过。
2. API、CDN、MQ、冷热分层与代码一致：通过。

### D. 工程落地检查
1. 阈值+动作完整：通过。
2. RTO/RPO 路径明确：通过。

### E. 代码相关性检查
1. Java 五类点位覆盖：通过。
2. 前端调用与重试幂等体现：通过。

### F. 母题差异检查
1. 与 Q22 差异具体：通过。

### 自评分（100）
1. 完整性：20/20
2. 易懂性：19/20
3. 面试可讲性：19/20
4. 技术深度：19/20
5. 工程落地性：19/20
总分：96/100（通过）
