# Q36：Design Amazon Recommendation System（95分面试版）

## 1. 三句话题目本质
1. 推荐系统不是“算一个分数”这么简单，而是“多阶段筛选 + 多目标优化 + 在线反馈闭环”的工程系统。  
2. 你要同时满足四件事：推荐效果好、响应快、可解释、成本可控。  
3. 面试高分关键是讲清召回-粗排-精排-重排、冷启动、AB 实验、以及故障降级策略。  

## 2. 一个真实场景故事
用户晚上 9 点打开电商首页，最近刚买了婴儿车：
- 她希望看到“相关但不重复”的商品，比如尿布、奶瓶、宝宝监控器。
- 平台希望提升 GMV，不只是提升点击。
- 运营希望插入活动位，模型不能完全“黑箱独裁”。

如果系统只推“全站热门”，用户觉得不相关。  
如果系统只推“她刚买过的同款”，体验又很差。  
这就是推荐系统的核心矛盾：个性化、业务目标和用户体验要同时平衡。

## 3. 术语白话表（至少 10 项）
| 术语 | 白话解释 | 面试可复述 |
|---|---|---|
| Recall（召回） | 从千万商品里先挑几千个候选 | “先缩小范围，再精排” |
| Coarse Rank（粗排） | 快速打分筛掉明显不合适的候选 | “便宜快的初筛” |
| Fine Rank（精排） | 用复杂模型算更准确分数 | “贵但准的排序” |
| Re-rank（重排） | 对精排结果做多样性和业务规则调整 | “最后把结果调顺眼” |
| CTR | 点击率 | “用户愿不愿意点” |
| CVR | 转化率 | “点了之后会不会买” |
| GMV | 成交额 | “平台收入核心指标之一” |
| Cold Start | 冷启动 | “新用户/新商品没历史数据” |
| Exploration | 探索 | “给新内容一些曝光机会” |
| Exploitation | 利用 | “优先推荐历史上效果好的内容” |
| Feature Store | 特征仓库 | “训练和在线共享特征来源” |
| ANN | 近似最近邻检索 | “向量召回常用高效算法” |
| Exposure Bias | 曝光偏差 | “只看已曝光样本会偏” |
| AB Test | 对照实验 | “新旧策略谁更好，用数据说话” |
| Guardrail Metric | 护栏指标 | “防止模型优化一项却伤害整体” |

## 4. 需求澄清（功能/非功能/不做范围）
### 4.1 功能需求
- 首页推荐、详情页“猜你喜欢”、购物车页关联推荐。
- 支持多召回通道（协同过滤、内容相似、热门趋势、规则位）。
- 支持实时行为反馈（曝光、点击、加购、购买）。
- 支持 AB 实验、灰度发布、策略回滚。
- 支持多目标优化（CTR、CVR、GMV、客诉率）。

### 4.2 非功能需求（SLO 示例）
- 推荐接口延迟：`P95 <= 120ms`，`P99 <= 200ms`。
- 可用性：`>= 99.95%`。
- 推荐成功率（有结果返回）：`>= 99.9%`。
- 特征新鲜度：行为特征延迟 `<= 5 分钟`。
- AB 配置生效延迟：`<= 1 分钟`。

### 4.3 Out of Scope（首版不做）
- 不做端到端在线训练（先离线训练 + 在线推断）。
- 不做全站统一单模型（先按场景拆模型）。
- 不做复杂强化学习策略（可作为后续演进）。

## 5. 容量估算（含数字推导）
### 5.1 假设
- DAU：`120,000,000`
- 人均每日推荐请求：`18`
- 总请求：`2,160,000,000/day`
- 峰值系数：`7x`
- 商品池：`80,000,000`

### 5.2 QPS 估算
- 平均 QPS：`2.16B / 86400 ≈ 25,000`
- 峰值 QPS：`~175,000`

### 5.3 每请求计算预算
- 召回候选：`3000`
- 粗排保留：`300`
- 精排保留：`80`
- 最终返回：`20`

如果精排模型单样本 0.2ms，则 `300 * 0.2ms = 60ms`，已经占掉主要延迟预算。  
结论：必须分阶段，不能直接对全量候选做重模型。

### 5.4 存储和流处理估算
- 行为日志：假设 `20B events/day`，每条 200B -> `~4TB/day` 原始日志。
- 特征存储（用户向量 + 商品向量 +统计特征）轻松 TB 级。

## 6. 架构（简版 + 完整版）
### 6.1 简版架构
```text
Request -> Recall -> Coarse Rank -> Fine Rank -> Re-rank -> Return
Feedback -> Stream -> Feature Update -> Model Train
```

### 6.2 完整版架构
```text
[Client]
  -> [Recommendation API Gateway]
  -> [Context Builder] (user/device/page/time)
  -> [Multi-Recall Service]
       -> CF Recall
       -> Content/Embedding Recall(ANN)
       -> Trending Recall
       -> Rule/Promotion Recall
  -> [Candidate Merge/Dedup]
  -> [Coarse Rank Model]
  -> [Fine Rank Model]
  -> [Re-rank Engine] (diversity, business constraints, safety)
  -> [TopN Response]

[Feedback Pipeline]
  -> [Exposure/Click/Cart/Buy Events]
  -> [Kafka]
  -> [Feature Streaming Jobs]
  -> [Feature Store]
  -> [Offline Training + Eval + Model Registry]
  -> [Online Inference Service]
```

### 6.3 核心组件职责
- Multi-Recall：保证覆盖面，防止“只会推荐热门”。
- Fine Rank：保证相关性和转化率。
- Re-rank：保证结果“业务可用且用户看起来合理”。
- Feedback Pipeline：让系统持续变聪明。

## 7. API 设计（含请求/响应样例）
### 7.1 获取推荐列表
`POST /api/v1/recommendations`

Request:
```json
{
  "userId": 10233445,
  "scene": "HOME_FEED",
  "pageNo": 1,
  "pageSize": 20,
  "device": "ios",
  "locale": "zh-CN",
  "abBucket": "exp_20260224_b"
}
```

Response:
```json
{
  "requestId": "rec_20260224_8891",
  "tookMs": 94,
  "strategy": "home_v5",
  "items": [
    {
      "itemId": 900123,
      "reason": "看过婴儿车用户也常买",
      "score": 0.872,
      "channel": "cf_recall"
    }
  ]
}
```

### 7.2 上报行为反馈
`POST /api/v1/recommendations/feedback`

Request:
```json
{
  "requestId": "rec_20260224_8891",
  "userId": 10233445,
  "itemId": 900123,
  "eventType": "CLICK",
  "eventTs": 1771930000000
}
```

### 7.3 AB 配置查询（内部）
`GET /internal/v1/ab/strategy?scene=HOME_FEED&userId=10233445`

### 7.4 错误码语义
- `429_RECO_RATE_LIMITED`：推荐请求限流。
- `503_MODEL_TIMEOUT`：模型服务超时，进入降级。
- `206_PARTIAL_RECALL`：部分召回通道异常，返回降级结果。

## 8. 数据模型（核心表/索引）
### 8.1 用户画像表
```sql
CREATE TABLE user_profile (
  user_id BIGINT PRIMARY KEY,
  age_group VARCHAR(16),
  gender VARCHAR(8),
  city VARCHAR(64),
  device_type VARCHAR(32),
  interest_tags JSON,
  value_segment VARCHAR(16), -- high/mid/low
  updated_at TIMESTAMP NOT NULL
);
CREATE INDEX idx_user_city_segment ON user_profile(city, value_segment);
```

### 8.2 商品画像表
```sql
CREATE TABLE item_profile (
  item_id BIGINT PRIMARY KEY,
  category_id BIGINT NOT NULL,
  brand_id BIGINT,
  price BIGINT,
  quality_score DOUBLE,
  status VARCHAR(16) NOT NULL, -- online/offline
  tags JSON,
  updated_at TIMESTAMP NOT NULL
);
CREATE INDEX idx_item_category_status ON item_profile(category_id, status);
```

### 8.3 行为事件表（离线明细）
```sql
CREATE TABLE user_event (
  event_id BIGINT PRIMARY KEY,
  user_id BIGINT NOT NULL,
  item_id BIGINT NOT NULL,
  scene VARCHAR(32) NOT NULL,
  event_type VARCHAR(16) NOT NULL, -- exposure/click/cart/buy
  event_ts TIMESTAMP NOT NULL,
  request_id VARCHAR(64)
);
CREATE INDEX idx_event_user_time ON user_event(user_id, event_ts DESC);
CREATE INDEX idx_event_item_time ON user_event(item_id, event_ts DESC);
```

### 8.4 在线特征 KV（示意）
- `user:vec:{userId}` -> 向量 embedding
- `item:vec:{itemId}` -> 向量 embedding
- `user:recent:{userId}` -> 最近行为序列
- `scene:hot:{scene}` -> 场景热门榜

## 9. 核心流程（至少 3 条）
### 9.1 正常推荐流程
1. API 收到请求，构建用户上下文（设备、时间、场景、地域）。
2. 多召回并行执行，返回各通道候选（总 2k~5k）。
3. 去重并补齐特征，粗排筛到 300 左右。
4. 精排模型计算综合分（CTR/CVR/GMV）。
5. 重排执行多样性、去重、业务规则，输出 TopN。

### 9.2 高峰流程（大促场景）
1. 流量飙升，模型服务延迟升高。
2. 自动降级：精排保留样本从 300 降到 120。
3. 部分请求改用轻量模型 + 热门兜底。
4. 保证接口 SLA 优先，牺牲少量效果。

### 9.3 故障恢复流程（某召回通道挂掉）
1. 向量召回通道超时率升高。
2. 系统标记通道 unhealthy，快速摘除。
3. CF + 热门 + 规则通道顶上，保证有结果返回。
4. 通道恢复后灰度放量，验证效果再全量。

### 9.4 冷启动流程（新用户）
1. 用户无历史行为，无法个性化召回。
2. 使用“地域 + 时间段 + 人群分层”的热门策略。
3. 给 10~20% 曝光留给探索内容，快速收集兴趣信号。
4. 行为积累后逐步切到个性化权重。

## 10. 一致性与事务边界
### 10.1 一致性级别
- 推荐结果允许最终一致（特征分钟级延迟可接受）。
- 支付/库存强一致由交易系统负责，不在推荐链路内保证。

### 10.2 事务边界
- 推荐请求本身无跨库事务，核心是低延迟读取与计算。
- 行为上报采用“至少一次”语义，训练侧去重幂等。

### 10.3 去重与幂等
- 事件去重键可用 `requestId + itemId + eventType + eventTsBucket`。
- 防止重复曝光/点击事件污染训练样本。

## 11. 可用性与容错
### 11.1 常见故障
- 模型推断服务超时。
- 特征服务短时不可用。
- 某召回通道突发异常。
- 推荐接口整体过载。

### 11.2 容错策略
- 模型超时降级到轻量模型或规则排序。
- 特征缺失时使用离线快照默认值。
- 召回通道熔断隔离，通道级健康检查。
- 全链路限流 + 过载保护，优先核心场景（首页 > 低价值页面）。

### 11.3 RTO / RPO
- RTO：核心推荐链路 `<= 5 分钟`（降级可即时生效）。
- RPO：行为日志允许分钟级延迟补齐。

## 12. 可观测性（指标 + 告警阈值）
### 12.1 在线服务指标
- `reco_latency_p95_ms`
- `reco_error_rate`
- `reco_success_with_items_rate`
- `model_timeout_rate`

阈值示例：
- `reco_latency_p95_ms > 120` 持续 10 分钟 -> P1
- `reco_error_rate > 0.5%` 持续 5 分钟 -> P1
- `model_timeout_rate > 3%` 持续 5 分钟 -> P1

### 12.2 效果指标
- `ctr`, `cvr`, `gmv_per_mille`
- `add_to_cart_rate`
- `repeat_exposure_rate`（重复曝光率）
- `novelty/diversity_score`

阈值示例：
- `ctr` 日环比下降 > 8% -> P1
- `repeat_exposure_rate > 25%` -> P2

### 12.3 训练与数据质量指标
- `feature_freshness_lag_min`
- `event_dedup_ratio`
- `training_sample_skew`

阈值示例：
- `feature_freshness_lag_min > 10` 持续 30 分钟 -> P1
- `event_dedup_ratio < 95%` -> P2

## 13. 安全与合规
- 用户隐私保护：特征脱敏、最小化采集、可撤回机制。
- 敏感属性治理：不直接用敏感字段做差别化推荐。
- 审计：策略变更、实验开关、运营规则全量记录。
- 反作弊：刷点击、刷单信号进入风控，避免污染模型。
- 合规：遵守本地数据法规（数据存储地域、保留期限）。

## 14. 成本与取舍
### 14.1 成本组成
- 在线推断计算成本（CPU/GPU）。
- 特征存储与流处理成本。
- 召回索引与向量检索成本。

### 14.2 关键取舍
- 精排样本越多效果越好，但延迟和成本越高。
- 召回通道越多覆盖越好，但融合复杂度上升。
- 实时特征越新鲜效果越好，但流计算成本更高。

### 14.3 降本策略
- 分层推断：轻重模型按流量分层使用。
- 召回预算控制：每通道候选上限可动态调整。
- 低价值场景关闭重模型，使用规则+轻模型。
- 通过 AB 评估“单位算力收益”，淘汰低 ROI 特征和模型。

## 15. Java 关键代码（至少 4 段，点位不同）
### 15.1 多路召回融合去重
```java
public class MultiRecallMerger {
    public List<Long> merge(Map<String, List<Long>> channelResults, int limit) {
        LinkedHashSet<Long> dedup = new LinkedHashSet<>();
        List<String> order = List.of("cf", "embedding", "trending", "rules");

        for (String channel : order) {
            List<Long> ids = channelResults.getOrDefault(channel, List.of());
            for (Long id : ids) {
                dedup.add(id);
                if (dedup.size() >= limit) {
                    return new ArrayList<>(dedup);
                }
            }
        }
        return new ArrayList<>(dedup);
    }
}
```

### 15.2 粗排服务（快速筛选）
```java
public class CoarseRankService {
    public List<Candidate> topK(List<Candidate> candidates, int k) {
        return candidates.stream()
            .peek(c -> c.setCoarseScore(
                0.5 * c.getCtrPred() +
                0.2 * c.getRecencyScore() +
                0.3 * c.getUserMatchScore()))
            .sorted(Comparator.comparingDouble(Candidate::getCoarseScore).reversed())
            .limit(k)
            .toList();
    }
}
```

### 15.3 精排 + 多目标打分
```java
public class FineRankService {
    public double score(Candidate c) {
        // 例子：将 CTR/CVR/GMV 多目标融合成一个在线分数
        double ctr = c.getCtrPred();
        double cvr = c.getCvrPred();
        double gmv = Math.log(1 + c.getExpectedGmv());
        double penalty = c.isHighComplaintRisk() ? 0.2 : 0.0;
        return 0.45 * ctr + 0.35 * cvr + 0.20 * gmv - penalty;
    }
}
```

### 15.4 重排：多样性 + 业务规则
```java
public class ReRankService {
    public List<Candidate> rerank(List<Candidate> ranked, int topN) {
        Map<Long, Integer> categoryCount = new HashMap<>();
        List<Candidate> out = new ArrayList<>();

        for (Candidate c : ranked) {
            long cat = c.getCategoryId();
            int cnt = categoryCount.getOrDefault(cat, 0);
            if (cnt >= 3) continue; // 同类最多 3 个
            if (!c.isAvailable()) continue; // 下架商品过滤
            out.add(c);
            categoryCount.put(cat, cnt + 1);
            if (out.size() == topN) break;
        }
        return out;
    }
}
```

### 15.5 反馈事件幂等落库
```java
public class FeedbackIngestService {
    public void ingest(FeedbackEvent e) {
        String dedupKey = e.getRequestId() + ":" + e.getItemId() + ":" + e.getEventType() + ":" + (e.getEventTs() / 1000);
        if (dedupRepo.exists(dedupKey)) return;

        eventRepo.insert(e);
        kafkaProducer.send("reco-feedback", e);
        dedupRepo.save(dedupKey, 2 * 24 * 3600); // 2天去重窗口
    }
}
```

## 16. 测试策略
### 16.1 单元测试
- 召回融合去重逻辑正确性。
- 粗排和精排分数单调性、边界值。
- 重排规则（多样性、业务约束）符合预期。

### 16.2 集成测试
- 推荐请求全链路（召回->排序->重排）延迟和结果完整性。
- 事件上报->流处理->特征更新链路稳定性。
- 模型服务超时时降级路径可用性。

### 16.3 压测
- 高峰 18 万 QPS 压测下 P95。
- 模型服务 30% 慢请求注入，验证熔断与回退。
- 热门商品极端偏斜流量（Zipf）下稳定性测试。

### 16.4 实验与回归
- AB 看 `CTR/CVR/GMV` 是否提升，同时看护栏指标（退货率、投诉率）。
- 新模型上线前做离线回放 + 小流量灰度 + 自动回滚阈值。

## 17. 丰富例子（至少 10 个）
1. 新用户首次访问首页，先用“本地热门+类目探索”推荐。  
2. 用户刚买过洗衣液，短期内降低同款曝光频率，避免重复骚扰。  
3. 购物节期间运营活动位插入，但不允许挤占前 3 位全部资源。  
4. 高客诉商品即使 CTR 高，也被重排策略降权。  
5. 某召回通道（向量检索）故障，系统自动切到 CF + 热门兜底。  
6. 深夜低流量时增加探索比例，收集长尾商品反馈。  
7. 某类目库存紧张，重排阶段做库存可售过滤。  
8. 用户近期连续浏览母婴，模型在首页提高母婴权重。  
9. 新商品无行为数据，通过内容标签和相似 embedding 获得初始曝光。  
10. 模型版本升级后 CTR 提升 2%，但投诉率升高 8%，被护栏指标拦截。  
11. 移动端网络差时，策略切轻量特征，确保响应在 120ms 内。  
12. 同一品牌商品过多时，多样性约束自动打散品牌分布。  

## 18. 面试追问 + 可复述回答
### Q1：为什么要分召回、粗排、精排三层？
可复述：  
“因为全量商品直接精排成本太高。分层可以先快筛再精算，在时延预算内拿到更好效果。”

### Q2：冷启动怎么做？
可复述：  
“新用户用人群分层热门+探索，新商品用内容特征和相似商品召回，靠早期反馈快速冷启动。”

### Q3：如何避免推荐越来越‘窄’（信息茧房）？
可复述：  
“重排阶段加多样性约束，并保留一定探索流量，防止系统只推单一兴趣。”

### Q4：推荐效果到底看 CTR 还是 GMV？
可复述：  
“单看 CTR 会偏标题党，单看 GMV 会牺牲体验。实践里要做多目标优化并设置护栏指标。”

### Q5：模型服务挂了怎么办？
可复述：  
“熔断重模型，降级轻模型或规则热门，先保可用与时延，再逐步恢复效果。”

### Q6：AB 实验如何避免误判？
可复述：  
“做随机分桶、保证样本量、观察周期覆盖周内波动，同时看主指标和护栏指标。”

## 19. 新手学习路线
### 第 1 周：先做规则推荐
- 做热门推荐、类目推荐、最近浏览推荐。
- 学会事件埋点（曝光/点击/购买）。

### 第 2 周：补齐召回和粗排
- 加协同过滤和内容相似召回。
- 用逻辑回归或 GBDT 做粗排。

### 第 3 周：补齐精排和重排
- 引入更复杂模型（如 DNN）做精排。
- 加多样性、去重、库存、运营规则。

### 第 4 周：工程化和实验化
- 建 AB 平台接入。
- 做故障降级和监控告警。
- 准备“10 分钟面试版”讲解稿。

## 20. 上场前 Checklist
- [ ] 我能讲清召回、粗排、精排、重排各自职责。  
- [ ] 我能说明冷启动的用户侧和商品侧方案。  
- [ ] 我能说出至少 3 个效果指标和 2 个护栏指标。  
- [ ] 我能给出模型超时时的降级路径。  
- [ ] 我能解释 AB 实验怎么做才可信。  
- [ ] 我能讲清特征新鲜度为什么影响效果。  
- [ ] 我能用一个真实例子说明“效果-时延-成本”取舍。  

## 21. 30 秒总结
推荐系统的高分答案是：  
“用多路召回保证覆盖，用粗排精排保证准确，用重排保证用户体验和业务约束，再用反馈和 AB 持续迭代。”  
你只要把这句话落到容量估算、时延预算、降级策略和代码点位上，面试官会认为你不仅懂算法，也懂工程落地。  
